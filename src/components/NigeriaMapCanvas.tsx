import { useEffect, useRef, useMemo } from "react";
import { stateCoordinates } from "@/data/stateCoordinates";

interface StateStatus {
  available: number;
  unavailable: number;
}

interface NigeriaMapCanvasProps {
  reportsByState: Record<string, StateStatus>;
  onStateClick?: (stateName: string) => void;
}

// SimpleMaps Nigeria map paths data
const mapPaths: Record<string, string> = {
  NGAB: "M468.5 477.9l0.1 0.1 0.1 0 0 0.1 0.4 0.1 0.1 0.1 0.1 0 0.1 0 0.1 0.1 0 0 0.1 0 0.1 0.1 0.1 0 0.1 0.1 0 0.1 0 0 0 0.1 0 0.1 0.1 0.1 0.2 0 0 0.1 0.1 0.1 0.1 0 0.1 0.1 0.1 0 0.1 0 0.1 0 0.1 0.1 0.1 0 0.1 0 0 0 0.1 0 0.1 0.1 0 0 0.1 0 0 0 0.1 0 0.1 0 0 0 0.1 0.1 0 0 0.1 0 0.1 0 0 0.1 0.1 0 0.1 0 0.1 0.1 0.2 0 0.1 0 0.1 0 0.1 0 0 0 0.1 0.1 0.1 0 0.1 0.1 0 0 0.1 0.1 0.1 0 0.1 0 0.1 0.1 0.2 0.1 0.1 0.1 0.1 0 0.1 0 0.1 0 0.1 0 0.1 0 0.1 0.1 0.1 0 0.1 0.1 0.1 0.1 0.1 0 0.1 0 0.1 0 0.1 0.1 0.1 0 0.1 0 0 0 0.1 0.1 0.2 0.1 0.1 0 0.1 0 0.1 0 0.1 0 0.1 0 0 0 0.1 0 0 0.1 0.1 0 0.1 0 0.1 0 0.1 0 0 0.1 0.1 0 0.1 0 0 0 0.1 0 0.1 0 0.1 0 0.1 0 0.1 0 0.1 0 0 0 0.1 0 0 0 0.1 0 0 0 0.1 0 0.1 0 0 0 0.1 0 0 0 0.1 0 0.1 0 0.1 0.1 0 0 0.1 0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0.1 0 0.1 0 0.1 0 0 0 0.1 0 0 0.1 0 0.1 0.1 0 0.1 0 0 0 0.1 0 0.1 0 0.1 0 0.1 0.1 0.1 0 0.1 0 0 0 0.1-0.1 0.1-0.1 0 0 0 0 0.1 0 0 0 0.1 0 0.1 0 0 0 0.1 0 0.1 0 0.1 0 0.1 0 0.1 0 0.1 0 0.1-0.1 0.1 0 0 0 0.1 0 0.1 0 0.1 0 0-0.1 0.1 0 0.1 0 0.1-0.1 0 0 0.1 0 0 0 0.1 0 0.1 0 0.1-0.1 0 0 0.1 0 0 0 0-0.1 0.1 0 0.1-0.1 0.1 0 0 0 0.1 0 0.1 0 0 0 0 0 0.1 0 0 0 0.1 0 0.1-0.1 0 0 0.1 0 0 0 0.1 0 0 0 0.1 0 0 0 0.1-0.1 0.1 0 0.1 0 0 0 0.1 0 0 0 0 0 0.1 0 0.1-0.1 0 0 0.1 0 0 0 0.1 0 0 0.1 0.1 0.1 0.1 0.1 0 0 0.1 0 0.1 0 0 0 0-0.1 0.1 0 0-0.1 0.1-0.1 0 0 0.1 0 0-0.1 0.1 0 0 0 0.1 0 0 0 0.1 0 0 0.1 0 0 0.1 0.1 0.2 0.1 0.1 0 0 0 0.1 0 0.1-0.1 0.1 0 0-0.1 0.1 0 0 0.1 0.1 0 0.1 0.1 0.3-0.1 0.2-0.1 0.1 0 0.1 0.1 0.2 0 0.1 0 0 0.1 0.1 0 0.1-0.2 0-0.5-0.1-0.1 0-0.1 0-0.1 0 0 0-0.1 0-0.1 0 0 0-0.1 0-0.1 0.1-0.2 0-0.1 0.1-0.1 0-0.1 0.1-0.1 0.1-0.3 0.3-0.1 0-0.1 0.1-0.4 0.3-0.4 0.3-0.5-0.4-0.4-0.4-0.1 0-0.1-0.1-0.1-0.1-0.3 0-0.1-0.1 0-0.1-0.2 0-0.2-0.1-0.2-0.1-0.2 0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0.1-0.1 0-0.1 0.1-0.1 0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1-0.1-0.1-0.1-0.1 0-0.1-0.1 0-0.1-0.1-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1 0 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1 0 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0 0-0.1-0.1-0.1-0.1 0-0.1 0-0.1-0.1-0.1-0.1-0.2-0.1-0.1-0.1-0.1 0-0.1-0.1-0.2 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1-0.1-0.2-0.1-0.3-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0 0 0-0.1 0-0.1 0-0.1 0-0.1-0.1 0 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1 0-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1-0.1-0.1 0-0.1-0.1 0-0.1-0.1 0-0.1-0.1-0.1-0.1 0-0.1-0.1-0.1-0.1-0.1-0.1-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1 0 0-0.1-0.1-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1 0-0.1 0 0-0.1 0 0-0.1-0.1 0 0-0.1-0.1 0 0-0.1-0.1 0-0.1 0-0.1-0.1 0-0.1-0.1-0.1 0-0.1-0.1-0.1 0-0.1-0.1-0.1 0-0.1-0.1 0 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0 0-0.1-0.1-0.1-0.1 0 0-0.1-0.1-0.1-0.1 0-0.1-0.1-0.1 0-0.1-0.1 0-0.1 0-0.1-0.1-0.1-0.1-0.1 0-0.1-0.1-0.1 0 0-0.1-0.1 0-0.1-0.1-0.1 0-0.1-0.1-0.1 0-0.1-0.1-0.1 0-0.1-0.1-0.2-0.1 0-0.1-0.1-0.1 0-0.1-0.1-0.1-0.1-0.1 0-0.1-0.1-0.1-0.1-0.1-0.1-0.1 0-0.1-0.1-0.1-0.1-0.1 0-0.1-0.1-0.1 0-0.1 0 0-0.1 0 0-0.1-0.1-0.1 0-0.1-0.1-0.1-0.1-0.1 0-0.1-0.1-0.1 0-0.1-0.1 0 0-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0 0 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1 0 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1-0.1-0.1-0.1-0.1-0.1-0.1-0.1-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1-0.1 0 0-0.1-0.1-0.1 0-0.1-0.1 0-0.1-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1 0 0-0.1-0.1 0 0-0.1 0-0.1 0 0 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0 0 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1 0 0-0.1 0-0.1 0-0.1 0-0.1-0.1 0 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1 0 0-0.1 0-0.1 0-0.1 0 0 0-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1 0 0-0.1 0-0.1 0-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0 0 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1 0 0 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1 0 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0-0.1-0.1 0 0-0.1 0-0.1 0-0.1 0-0.1 0 0 0-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0-0.1 0 0 0-0.1 0-0.1 0-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0 0-0.1-0.1 0-0.1 0 0-0.1-0.1 0 0 0-0.1 0-0.1 0 0-0.1-0.1 0 0-0.1-0.1 0-0.1 0 0-0.1 0 0-0.1 0 0-0.1-0.1 0-0.1 0 0-0.1-0.1 0 0-0.1-0.1 0 0-0.1-0.1 0 0-0.1 0-0.1-0.1 0 0-0.1-0.1 0 0-0.1 0-0.1-0.1 0 0-0.1 0-0.1-0.1 0-0.1 0 0-0.1-0.1 0 0-0.1-0.1 0 0-0.1 0-0.1-0.1 0 0-0.1-0.1 0-0.1 0 0-0.1 0-0.1-0.1 0-0.1 0 0-0.1 0-0.1-0.1 0 0-0.1-0.1 0 0-0.1-0.1 0 0-0.1-0.1-0.1 0-0.1-0.1 0 0-0.1 0-0.1-0.1 0 0-0.1 0-0.1-0.1 0 0-0.1-0.1 0 0-0.1-0.1 0 0-0.1-0.1 0 0-0.1-0.1-0.1 0-0.1 0-0.1-0.1 0 0-0.1 0-0.1-0.1 0 0-0.1-0.1-0.1 0 0-0.1-0.1 0-0.1 0 0-0.1-0.1-0.1 0 0-0.1 0-0.1-0.1-0.1 0 0-0.1-0.1-0.1-0.1 0 0-0.1 0-0.1 0-0.1-0.1-0.1 0 0-0.1-0.1-0.1-0.1 0-0.1 0-0.1 0-0.1-0.1-0.1-0.1-0.1 0 0-0.1 0-0.1 0-0.1 0.1 0 0 0 0.1 0 0.1 0.1 0.1 0.1 0 0 0.1 0.1 0 0 0 0.1 0.1 0.1 0.1 0 0.1 0 0 0.1 0 0.1 0.1 0 0.1 0.1 0.1 0 0.1 0 0 0.1 0.1 0 0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0.1 0.1 0.1 0.1 0 0 0.1 0.1 0 0 0.1 0.1 0 0.1 0.1 0 0.1 0 0.1 0.1 0.1 0.1 0 0.1 0.1 0.1 0 0 0.1 0.1 0 0.1 0.1 0.1 0.1 0.1 0.1 0.1 0 0.1 0 0.1 0.1 0.2 0 0.1 0 0.1 0.1 0.2 0.1 0.1 0 0.1 0 0.1 0.1 0.1 0 0.1 0 0.2 0.1 0.1 0.1 0.1 0 0.1 0 0.1 0 0.2 0 0.1 0.1 0.1 0 0.1 0 0.1 0.1 0.1 0 0.1 0 0.2 0 0.2 0 0.1 0 0.1 0 0.1 0.1 0.2 0 0.1 0 0.1 0 0.2 0 0.1 0 0.1 0 0.2 0.1 0 0 0.1 0 0.2 0 0.2 0 0.1 0 0.1 0 0.1 0 0.1 0 0.1 0 0.1 0.1 0.2 0.1 0.1 0 0.1 0 0.1 0 0.1 0.1 0.2 0.1 0.1 0 0.1 0.1 0.1 0 0.1 0.1 0.3 0 0.1 0 0.1 0 0.1 0.1 0.1 0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0.1 0.1 0.1 0 0.1 0 0.1 0.1 0.1 0 0.1 0.1 0.1 0 0.1 0.1 0.1 0 0.1 0.1 0.1 0 0.1 0.1 0.1 0 0.1 0 0.1 0 0 0.1 0.1 0.1 0.1 0 0.1 0.1 0.1 0.1 0.1 0 0.1 0.1 0 0.1 0.1 0.1 0.1 0 0 0.1 0.1 0.1 0.1 0 0.1 0.1 0 0.1 0.1 0 0.1 0.1 0.1 0 0.1 0.1 0.1 0.1 0 0 0.1 0.1 0 0.1 0.1 0.1 0.1 0 0 0.1 0 0 0.1 0.1 0.1 0 0.1 0.1 0.1 0 0 0.1 0.1 0.1 0 0.1 0 0.1 0.1 0.1 0 0 0.1 0.1 0 0 0.1 0.1 0.1 0.1 0 0.1 0 0.1 0 0.1 0 0.1 0.1 0.1 0 0.1 0 0.1 0.1 0 0 0.1 0 0.1 0.1 0.1 0 0.1 0 0.1 0.1 0 0 0.1 0.1 0.1 0 0.1 0.1 0 0 0.1 0.1 0.1 0 0.1 0.1 0 0 0.1 0.1 0.1 0 0 0.1 0.1 0 0.1 0 0.1 0.1 0 0.1 0.1 0 0 0.1 0 0.1 0.1 0.1 0.1 0 0 0 0.1 0.1 0 0.1 0.1 0 0.1 0.1 0.1 0 0 0.1 0 0.1 0.1 0 0.1 0.1 0 0.1 0 0 0.1 0 0.1 0.1 0.1 0 0 0.1 0 0.1 0.1 0.1 0 0.1 0 0.1 0.1 0.1 0 0 0.1 0 0.1 0.1 0 0 0.1 0 0.1 0.1 0 0.1 0 0.1 0.1 0 0.1 0 0.1 0 0.1 0.1 0 0 0.1 0 0.1 0.1 0 0.1 0 0.1 0.1 0.1 0 0 0.1 0 0.1 0.1 0.1 0 0 0 0.1 0.1 0.1 0 0 0.1 0 0.1 0.1 0 0 0.1 0 0.1 0 0.1 0.1 0 0.1 0 0.1 0 0.1 0 0.1 0.1 0 0 0 0.1 0.1 0.1 0 0 0.1 0 0.1 0.1 0 0 0.1 0 0.1 0.1 0 0 0.1 0 0.1 0.1 0 0 0.1 0 0 0.1 0.1 0.1 0z",
  // Note: Full paths would be added here for all states
};

// State name to ID mapping
const stateIdMap: Record<string, string> = {
  "Abia": "NGAB",
  "Adamawa": "NGAD",
  "Akwa Ibom": "NGAK",
  "Anambra": "NGAN",
  "Bauchi": "NGBA",
  "Benue": "NGBE",
  "Borno": "NGBO",
  "Bayelsa": "NGBY",
  "Cross River": "NGCR",
  "Delta": "NGDE",
  "Ebonyi": "NGEB",
  "Edo": "NGED",
  "Ekiti": "NGEK",
  "Enugu": "NGEN",
  "Federal Capital Territory": "NGFC",
  "Gombe": "NGGO",
  "Imo": "NGIM",
  "Jigawa": "NGJI",
  "Kaduna": "NGKD",
  "Kebbi": "NGKE",
  "Kano": "NGKN",
  "Kogi": "NGKO",
  "Katsina": "NGKT",
  "Kwara": "NGKW",
  "Lagos": "NGLA",
  "Nasarawa": "NGNA",
  "Niger": "NGNI",
  "Ogun": "NGOG",
  "Ondo": "NGON",
  "Osun": "NGOS",
  "Oyo": "NGOY",
  "Plateau": "NGPL",
  "Rivers": "NGRI",
  "Sokoto": "NGSO",
  "Taraba": "NGTA",
  "Yobe": "NGYO",
  "Zamfara": "NGZA",
};

export function NigeriaMapCanvas({ reportsByState, onStateClick }: NigeriaMapCanvasProps) {
  const mapRef = useRef<HTMLDivElement>(null);

  // Get status for a state
  const getStateStatus = (stateName: string): "available" | "unavailable" | "none" => {
    const stateReports = reportsByState[stateName];
    if (!stateReports) return "none";
    const total = stateReports.available + stateReports.unavailable;
    if (total === 0) return "none";
    return stateReports.available >= stateReports.unavailable ? "available" : "unavailable";
  };

  // Calculate state centers from stateCoordinates for dot placement
  const stateDots = useMemo(() => {
    return stateCoordinates
      .map((state) => {
        const status = getStateStatus(state.name);
        if (status === "none") return null;
        
        const reports = reportsByState[state.name];
        const count = reports ? reports.available + reports.unavailable : 0;
        
        return {
          name: state.name,
          lat: state.lat,
          lng: state.lng,
          status,
          count,
        };
      })
      .filter(Boolean);
  }, [reportsByState]);

  // Convert lat/lng to SVG coordinates (Nigeria bounds: lat 4-14, lng 2.5-15)
  const latLngToSvg = (lat: number, lng: number) => {
    const minLat = 4;
    const maxLat = 14;
    const minLng = 2.5;
    const maxLng = 15;
    
    const x = ((lng - minLng) / (maxLng - minLng)) * 560 + 20;
    const y = ((maxLat - lat) / (maxLat - minLat)) * 480 + 20;
    
    return { x, y };
  };

  return (
    <div ref={mapRef} className="relative w-full aspect-[600/520]">
      <svg
        viewBox="0 0 600 520"
        className="w-full h-full"
        preserveAspectRatio="xMidYMid meet"
      >
        {/* Nigeria outline - simplified polygon */}
        <path
          d="M60,180 L90,120 L140,80 L200,50 L280,40 L360,50 L420,80 L480,120 L520,180 L540,260 L520,340 L480,400 L420,450 L340,480 L260,480 L180,450 L120,400 L80,340 L60,260 Z"
          className="fill-muted/50 stroke-border"
          strokeWidth="2"
        />
        
        {/* State boundaries - simplified representation */}
        {stateCoordinates.map((state) => {
          const { x, y } = latLngToSvg(state.lat, state.lng);
          const status = getStateStatus(state.name);
          
          return (
            <g key={state.name}>
              {/* State region circle (simplified) */}
              <circle
                cx={x}
                cy={y}
                r={18}
                className={`
                  transition-all duration-200 cursor-pointer
                  ${status === "available" ? "fill-success/20 stroke-success/40" : 
                    status === "unavailable" ? "fill-critical/20 stroke-critical/40" : 
                    "fill-muted/30 stroke-border/50"}
                `}
                strokeWidth="1"
                onClick={() => onStateClick?.(state.name)}
              />
            </g>
          );
        })}

        {/* Status dots overlay */}
        {stateDots.map((dot) => dot && (
          <g key={dot.name}>
            {/* Outer glow */}
            <circle
              cx={latLngToSvg(dot.lat, dot.lng).x}
              cy={latLngToSvg(dot.lat, dot.lng).y}
              r={12}
              className={`${dot.status === "available" ? "fill-success/30" : "fill-critical/30"}`}
            />
            {/* Main dot */}
            <circle
              cx={latLngToSvg(dot.lat, dot.lng).x}
              cy={latLngToSvg(dot.lat, dot.lng).y}
              r={7}
              className={`${dot.status === "available" ? "fill-success" : "fill-critical"} stroke-background`}
              strokeWidth="2"
            />
            {/* Pulse animation for unavailable */}
            {dot.status === "unavailable" && (
              <circle
                cx={latLngToSvg(dot.lat, dot.lng).x}
                cy={latLngToSvg(dot.lat, dot.lng).y}
                r={7}
                className="fill-none stroke-critical animate-ping"
                strokeWidth="2"
                style={{ animationDuration: "2s" }}
              />
            )}
            {/* State label */}
            <text
              x={latLngToSvg(dot.lat, dot.lng).x}
              y={latLngToSvg(dot.lat, dot.lng).y + 22}
              className="fill-foreground text-[6px] font-medium"
              textAnchor="middle"
            >
              {dot.name.length > 10 ? dot.name.substring(0, 8) + "..." : dot.name}
            </text>
          </g>
        ))}
      </svg>
    </div>
  );
}
